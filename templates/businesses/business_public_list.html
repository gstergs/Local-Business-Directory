{% extends 'base_generic.html' %}
{% load static %}

{% block content %}
<h2>Business List</h2>

<form method="get" class="mb-3">
    <div class="form-row align-items-center">
        <div class="col-auto">
            <input type="text" class="form-control" name="search" placeholder="Search by name..."> <!-- Search input -->
        </div>
        <div class="col-auto">
            <select class="form-control" name="category">
                <option value="">All Categories</option> <!-- Option to select all categories -->
                {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option> <!-- Category options -->
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-deep-blue">Search</button> <!-- Search button -->
        </div>
    </div>
</form>

<div class="row">
    {% for business in businesses %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 business-card">
                {% if business.image %}
                    <img src="{{ business.image.url }}" class="card-img-top" alt="{{ business.name }}"> <!-- Business image -->
                {% else %}
                    <img src="{% static 'images/default_image.png' %}" class="card-img-top" alt="Default Image"> <!-- Default image if no business image -->
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{% url 'businesses:business_detail' business.pk %}" class="text-primary">{{ business.name }}</a> <!-- Link to business detail page -->
                    </h5>
                    <p class="card-text">{{ business.description|truncatechars:100 }}</p> <!-- Truncated business description -->
                    <p class="card-text"><strong>Category:</strong> {{ business.category.name }}</p> <!-- Business category -->

                    {% if user.is_authenticated %}
                        <div class="d-flex justify-content-between">
                            {% if business in user.wishlist.businesses.all %}
                                <a href="{% url 'businesses:remove_from_wishlist' business.id %}" class="btn btn-danger">Remove from Wishlist</a> <!-- Remove from wishlist button -->
                            {% else %}
                                <a href="{% url 'businesses:add_to_wishlist' business.id %}" class="btn btn-deep-blue">Add to Wishlist</a> <!-- Add to wishlist button -->
                            {% endif %}
                            <a href="{% url 'businesses:submit_review' business.id %}" class="btn btn-success">Submit Review</a> <!-- Submit review button -->
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% empty %}
        <p>No businesses found.</p> <!-- Message displayed if there are no businesses -->
    {% endfor %}
</div>

<!-- Modal -->
<div class="modal fade" id="businessDetailModal" tabindex="-1" role="dialog" aria-labelledby="businessDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="business-detail-content">
            <!-- Content will be loaded here by AJAX -->
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $('.business-detail-link').on('click', function(e) {
            e.preventDefault();
            var businessId = $(this).data('id');
            $.ajax({
                url: '{% url "businesses:business_detail_ajax" %}',
                data: {
                    'id': businessId
                },
                success: function(data) {
                    $('#business-detail-content').html(data);
                    $('#businessDetailModal').modal('show');
                }
            });
        });
    });
</script>

{% endblock %}
